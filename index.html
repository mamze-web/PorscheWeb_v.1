<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Storage 파일 업로드 및 그래프</title>
    <!-- Chart.js 및 JSZip 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Google Maps API 및 MarkerClusterer 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDz2CZvDe4dViR8sxKPoTG-mNOUu6-AMeY&libraries=places"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>
    <main>
      
      <div id="addFolderDisplay">
        <div class="container">
          <div class="flex">
          <h1>주소 추가하기</h1>
          <div id="x" onclick="closedWindow()"><h1>x</h1></div>
        </div>
          <form id="info-form">

            <div id="info-form-details">
            <div id="logoZip">
              <label id="logolabel" for="logo">
                <img id="preview" />
              </label>
              <input type="file" id="logo" name="logo" ><br><br>
            </div>
          </div>
              <div id="addressZip">
                <button type="button" id="addressBtn" onclick="addressbutton()">주소 추가하기</button>
              <div id="addressDisplay"></div>
              
                <div id="addressHidden">
                  <input id="address" type="text" placeholder="Enter your address" />
                  <div id="address-details"></div>
                  <button type="button" id="fixbutton" onclick="fixBtn()">Fix!</button>
                </div>
              </div>
              <label for="group">그룹명</label>
              <input type="email" id="group" name="group"><br><br>
              
              <label for="label">보여질 이름</label>
              <input type="text" id="label" name="label"><br><br>
              
              <button type="button" id="submit-btn" onclick="closedWindow()">Submit</button>
          </form>
      </div>
      
    </div>
    
      <div id="file-list"></div>
        <div id="leftThing" > 
            <div id="secondwindow">
              
            </div>
            <div id="clickarrow"onclick="leftThing()">
                <span id="arrow">></span>
            </div>
            <div id="openwindow" >
                <div>
                  <button id="addschool" onclick="addschool()">주소 추가</button>
                <div id="searchzip">
                <img id="searchimg" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fsearch-interface-symbol.png?alt=media&token=a2fe1515-97b0-414f-9900-26280b475c19">
                <input id="search" type="text"  placeholder="주소를 검색하세요." onchange="searchAddress()">
                <div id="line"></div>
                </div>
                <hr>
                <div id="folder">
                <div class="folderZip">
                <ul id="label-list"></ul>
                </div>
                
                </div>
                </div>
                <div id="honeycombtext">
                <img class="honeycomb" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fhoneycomb.png?alt=media&token=09a7fc9b-6f08-42f3-b123-c0e2a6bc66d4">
                <span>공학도서관 X Porsche</span>
                </div>
              </div>
            </div>
            
               
           
       
   
        <div id="addwindow">
        </div>
            </div>
            <div class="blur">
                <div id="map"></div>     
            </div>

            <div id="right_info">
                
            </div>         
            </div>    
        </div>
      </div>
    </div>


    <div id="test">
      <h1> test</h1>
    </div>
    </main>
    <!-- Firebase 초기화 스크립트 -->
  <script>
        let count = 0;
        let count2 = 0;
        let map;
        let markers = [];
        window.onload = function() {
            // 업로드된 폴더 목록 가져오기
            // 맵 초기화
            initMap();
          iframeload();

        };  



document.addEventListener('DOMContentLoaded', () => {
      const submitBtn = document.getElementById('submit-btn');

      submitBtn.addEventListener('click', () => {
          // Get values from the input fields
          const logo = document.getElementById('logo').value;
          const address = document.getElementById('address').value;
          const group = document.getElementById('group').value;
          const label = document.getElementById('label').value;

          // Store values in variables
          const formData = {
              logo:logo,
              
              address:address,
              group:group,
              label:label
          };
          var geocoder = new google.maps.Geocoder();
        
          geocodeAddress(geocoder, address);
          
          
});});


function iframeload(){
  console.log("아이프레임 로드");
  window.addEventListener("message", function(message){
    console.log("test_0603");
      const msg = message;
      const test = document.querySelector("#test");
      test.appendChild(`<h1>${msg}</h1> `)
    alert(message.data);
    console.log(message.data)
    window.parent.postMessage(text);
    window.parent.postMessage(message.data);
  })

}

function geocodeAddress(geocoder, address) {
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();
                    fetch("https://gongdo.kr/api/datapi/place/add",{
            method:"POST",
            body: JSON.stringify({
                "datapiId": "eNRiOKLhAvdRTUjocI2J",
                "groupId": group,
                "form": {
                  "label": label,
                  "address": address,
                  "geolocation": {
                    "lat": lat,
                    "lng": lng
                  }
                }
            })
          }).then((res)=> {
            console.log(res);
            return res.json()
            })
          .then((result) => console.log("결과: ", result));
          // Output the formData to the console (or handle as needed)
      
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
          }
            )}

function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('카').src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  } else {
    document.getElementById('preview').src = "";
  }
}


function addressbutton(){
  document.getElementById("addressHidden").style.display="block"
}

function initAutocomplete() {

    // Create the autocomplete object, restricting the search predictions to geographical location types.
    const autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('address'),
        { types: ['geocode'] }
    );

    // When the user selects an address from the dropdown, populate the address fields in the form.
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        const addressDetails = document.getElementById('address-details');
        
        // Get the address components and display them.
      
    });
}

function addschool(){
  initAutocomplete()

  let addFolderDisplay = document.getElementById('addFolderDisplay');
  addFolderDisplay.classList.toggle('addFolderDisplay-click')

}
function closedWindow(){
  addFolderDisplay.classList.toggle('addFolderDisplay-click')
}
function searchAddress(){
  const searchInput = document.getElementById("search");
    const searchValue = searchInput.value.trim(); // 공백 제거
    
    // 검색어로 폴더 리스트 정렬
    sortFolderList(searchValue);
    let searchAddressValue = document.getElementById("search").value;
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': searchAddressValue }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}
function fixBtn(){
  const fixaddress = document.getElementById('address').value;
  addressDisplay.innerHTML=fixaddress;
  document.getElementById("addressHidden").style.display="none";
}
function sortFolderList(searchValue) {
    const folderList = document.getElementById('folder-list');
    const folders = folderList.getElementsByTagName('li');

    for (let i = 0; i < folders.length; i++) {
        const folder = folders[i];
        const folderName = folder.textContent || folder.innerText;
        
        // 검색어가 폴더 이름에 포함되어 있는지 확인
        if (folderName.includes(searchValue)) {
            // 매칭되는 폴더를 맨 위로 이동
            folderList.insertBefore(folder, folderList.firstChild);
        }
    }
}
function searchAddressfromFolder(folderRef){
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': folderRef.name }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}

function leftThing(){
    const secondwindow = document.getElementById("secondwindow")
    const arrow = document.getElementById("arrow")
    
    const leftThing = document.getElementById("leftThing")
    leftThing.classList.add('leftThing-click' , true)


    if(count%2==0){
        leftThing.classList.toggle('leftThing-click',true);
        arrow.innerHTML='<'
        count = count+1;
    }
    else if(count%2==1){
        leftThing.classList.toggle('leftThing-click',false);
        arrow.innerHTML='>'
        count = count+1;
        secondwindow.classList.toggle('secondwindow-click' , false)
        count2=0;
    }
}
function opensecondwindow(folderRef){
    secondwindow.classList.toggle('secondwindow-click' , true )
    secondwindow.innerHTML='<h1>'+folderRef.name+'</h1>'
}

function displaynone(){
    document.getElementById('left').style.display = 'none';
    sel.innerHTML='<span id="addressbar" onclick=displaynone()>학교목록 >';
}
        
function addbtn(){
  document.getElementById('addwindow').style.display = 'block';
}
        
        // 파일 처리하기
function sleep(ms) {
    const wakeUpTime = Date.now() + ms;
    while (Date.now() < wakeUpTime) {}
}

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5642135, lng: 127.0016985 },
        zoom: 8,
        disableDefaultUI: true,
        styles:[
  {
    "elementType": "geometry",
    "stylers": [
  {
    "featureType": "road",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  }
]
  }
]})


// 마커 클러스터러 생성
    markerCluster = new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
    });
   
    }
      function geocodeAndMark(address , folderRef) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    const marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: address
                    });
                    
                    // 클릭 이벤트 리스너 추가
                    marker.addListener('click', function() {
                        const infowindow = new google.maps.InfoWindow({
                            content: address
                        });
                        infowindow.open(map, marker);
                        opensecondwindow(folderRef)

                        // 원하는 동작 추가
                        // 예: 특정 정보를 오른쪽 정보 창에 표시
                        
                    });

                } else {
                    console.error('Geocode was not successful for the following reason:', status);
                }
            });
        }

        // 맵에 마커 추가
function addMarker(location, address) {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: address,
        icon: {
        url: 'https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fbee.png?alt=media&token=4707b1b3-67fc-4d7c-a57a-53d5ef4265a4', // 변경할 마커 이미지의 URL
        scaledSize: new google.maps.Size(50, 50), // 이미지 크기 조절
        origin: new google.maps.Point(0, 0), // 이미지의 원점 설정
        anchor: new google.maps.Point(25, 25) // 이미지의 중심점 설정
    }


    });
    marker.addListener('click', function() {
        const right_info = document.getElementById("right_info");
        right_info.classList.add('right_info_moved');
        right_info.classList.toggle('right_info_moved');
        // 마커의 주소 가져오기
        const markerAddress = marker.getTitle();

        // 인포윈도우 생성
        const infowindow = new google.maps.InfoWindow({
            content: markerAddress
        });

// 클릭한 마커 위에 인포윈도우 표시
infowindow.open(map, marker);
});
// 마커 위치로부터 주소를 지오코딩하는 함수




markers.push(marker); // 마커를 배열에 추가

// 클러스터러에 마커 추가
markerCluster.addMarker(marker);


// 폴더 경로에서 주소를 가져와 맵에 마커 표시
function addAddressMarker(folderPath, address) {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            addMarker(location, address);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}}

    </script>
</body>
</html>