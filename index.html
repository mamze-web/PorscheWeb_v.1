<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Storage 파일 업로드 및 그래프</title>
    <!-- Chart.js 및 JSZip 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Google Maps API 및 MarkerClusterer 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDz2CZvDe4dViR8sxKPoTG-mNOUu6-AMeY&libraries=places"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>
    <main>
       
        <div id="leftThing" > 
            <div id="secondwindow">
              와~
            </div>
            <div id="clickarrow"onclick="leftThing()">
                <span id="arrow">></span>
            </div>
            <div id="openwindow" >
                <div id="searchzip">
                <img id="searchimg" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fsearch-interface-symbol.png?alt=media&token=a2fe1515-97b0-414f-9900-26280b475c19">
                <input id="search" type="text"  placeholder="주소를 검색하세요." onchange="searchAddress()">
                <div id="line"></div>
                </div>
                
                <hr>
                <ul id="folder-list"></ul>
                
                </div>
                <div id="honeycombtext">
                <img class="honeycomb" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fhoneycomb.png?alt=media&token=09a7fc9b-6f08-42f3-b123-c0e2a6bc66d4">
                <span>공학도서관 X Porsche</span>
                </div>
                
            </div>
            
               
           
        </div>
     
   
        <div id="addwindow">
        </div>
            </div>
            <div class="blur">
                <div id="map"></div>     
            </div>

            <div id="right_info">
                
            </div>         
            </div>    
        </div>
    </main>
    <!-- Firebase 초기화 스크립트 -->
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
    <script>
        let count = 0;
        let count2 = 0;
        let map;
        let markers = [];
        window.onload = function() {
            // 업로드된 폴더 목록 가져오기
            // 맵 초기화
            initMap();
            listFolders();

        };  
        const firebaseConfig = {
            apiKey: "AIzaSyAz3IZwipq6OS8f9ucO9j1ZKxyo-u78NIw",
  authDomain: "macband-cf215.firebaseapp.com",
  databaseURL: "https://macband-cf215-default-rtdb.firebaseio.com",
  projectId: "macband-cf215",
  storageBucket: "macband-cf215.appspot.com",
  messagingSenderId: "586331708886",
  appId: "1:586331708886:web:8a4416d2e48e9565c65877"
        };

        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const listFolders = async () => {
            const storageRef = storage.ref().child('uploads');
            const folderList = document.getElementById('folder-list');

            try {
                const res = await storageRef.listAll();
                
                res.prefixes.forEach((folderRef) => {
                    const li = document.createElement('li');
                    li.textContent = folderRef.name;
                    li.onclick = () => {
                        opensecondwindow(folderRef)
                    }
                    folderList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing folders:', error);
            }
            const handleFolderClick = (folderRef) => {
            alert(`You clicked on folder: ${folderRef}`);
            // 여기에 원하는 기능을 추가하십시오.
        };}

function searchAddress(){
    let searchAddressValue = document.getElementById("search").value;
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': searchAddressValue }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}

function leftThing(){
    const secondwindow = document.getElementById("secondwindow")
    const arrow = document.getElementById("arrow")
    
    const leftThing = document.getElementById("leftThing")
    leftThing.classList.add('leftThing-click' , true)


    if(count%2==0){
        leftThing.classList.toggle('leftThing-click',true);
        arrow.innerHTML='<'
        count = count+1;
    }
    else if(count%2==1){
        leftThing.classList.toggle('leftThing-click',false);
        arrow.innerHTML='>'
        count = count+1;
        secondwindow.classList.toggle('secondwindow-click' , false)
        count2=0;
    }
}
function opensecondwindow(folderRef){
    secondwindow.classList.toggle('secondwindow-click' , true)
    secondwindow.innerHTML='<h1>'+folderRef.name+'</h1>'
}
function displaynone(){
    document.getElementById('left').style.display = 'none';
    sel.innerHTML='<span id="addressbar" onclick=displaynone()>학교목록 >';
}
        
        
        // 파일 처리하기
function sleep(ms) {
    const wakeUpTime = Date.now() + ms;
    while (Date.now() < wakeUpTime) {}
}
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5642135, lng: 127.0016985 },
        zoom: 8,
        disableDefaultUI: true,
        styles:[
  {
    "stylers": [
      {
        "color": "#606060"
      }
    ]
  },
  {
    "featureType": "administrative",
    "stylers": [
      {
        "color": "#ffffff"
      },
      {
        "saturation": -100
      },
      {
        "visibility": "simplified"
      }
    ]
  },
  {
    "featureType": "landscape.natural",
    "stylers": [
      {
        "color": "#929292"
      }
    ]
  },
  {
    "featureType": "poi",
    "stylers": [
      {
        "color": "#aaaaaa"
      },
      {
        "weight": 0.5
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "labels",
    "stylers": [
      {
        "color": "#ffffff"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "stylers": [
      {
        "visibility": "simplified"
      }
    ]
  },
  {
    "featureType": "water",
    "stylers": [
      {
        "color": "#ffffff"
      }
    ]
  }
]
            });

// 마커 클러스터러 생성
    markerCluster = new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
    });
    }

        // 맵에 마커 추가
function addMarker(location, address) {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: address,
        icon: {
        url: 'https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fbee.png?alt=media&token=4707b1b3-67fc-4d7c-a57a-53d5ef4265a4', // 변경할 마커 이미지의 URL
        scaledSize: new google.maps.Size(50, 50), // 이미지 크기 조절
        origin: new google.maps.Point(0, 0), // 이미지의 원점 설정
        anchor: new google.maps.Point(25, 25) // 이미지의 중심점 설정
    }


    });
    marker.addListener('click', function() {
        const right_info = document.getElementById("right_info");
        right_info.classList.add('right_info_moved');
        right_info.classList.toggle('right_info_moved');
        // 마커의 주소 가져오기
        const markerAddress = marker.getTitle();

        // 인포윈도우 생성
        const infowindow = new google.maps.InfoWindow({
            content: markerAddress
        });

// 클릭한 마커 위에 인포윈도우 표시
infowindow.open(map, marker);
});
// 마커 위치로부터 주소를 지오코딩하는 함수




markers.push(marker); // 마커를 배열에 추가

// 클러스터러에 마커 추가
markerCluster.addMarker(marker);


// 폴더 경로에서 주소를 가져와 맵에 마커 표시
function addAddressMarker(folderPath, address) {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            addMarker(location, address);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}}

    </script>
</body>
</html>