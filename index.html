<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Storage 파일 업로드 및 그래프</title>
    <!-- Chart.js 및 JSZip 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Google Maps API 및 MarkerClusterer 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDz2CZvDe4dViR8sxKPoTG-mNOUu6-AMeY&libraries=places"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>
    <main>
      
      <div id="addFolderDisplay">

          <div class="flex">
            <div id="add">
          <h1>주소 추가하기</h1>
          <div id="x" onclick="closedWindow()"><h1>x</h1></div>
          </div>
        </div>
          <form id="info-form">

          
            <div class="flex">
              <div id="addressZip">
                  <input id="address" type="text" placeholder="주소를 입력해주세요!" />

                  <button type="button" id="fixbutton" onclick="fixBtn()">검색</button>
                </div>
              
              </div>
              <div id="addressDisplay"></div>
              <div id="info-form-zip">
              <div id="info-form-hidden">
            <!-- <div id="info-form-flex"> -->
            <div id="logoZip">
              <label id="logolabel" for="logo">
                <img id="preview" />
              </label>
              <input type="file" id="logo" name="logo"onchange="readURL(this);" ><br><br>
          </div>
          <div id="display-flex">
              <div id="display-block">
              <label for="label" id="displayName"><h2>보여질 이름</h2></label>
              <input type="text" id="label" name="label"><br><br>
            </div>
          </div>
            <!-- </div> -->
              <button type="button" id="submit-btn" onclick="closedWindow()">주소 찾기</button>
            </div>
          </div>
            </form>

      
    </div>
    
      <div id="file-list"></div>

        <div id="leftThing" > 
          <div id="ifinfomation">
            <div id="profilePhoto"></div>
          </div>
          
            <div id="secondwindow">
              <div id="secondwindowLogo"></div>
            </div>
            <div id="clickarrow"onclick="leftThing()">
                <span id="arrow">✔️ 나의 주소 추가하기</span>
            </div>
            <div id="openwindow" >

                  <button id="addschool" onclick="addschool()">주소 찾기</button>
                <div id="line"></div>
                <h1 id="otherDatapi">다른 데이터파이 둘러보기</h1>
                <div id="folder">
                <div id="folderZip">
                <ul id="label-list"></ul>
                </div>
                
                </div>
                </div>
               

            </div>
            
               
           
       
   
        <div id="addwindow">
        </div>
            </div>
            <div class="blur">
                <div id="map"></div>     
            </div>

            <div id="right_info">
                
            </div>         
            </div>    
        </div>
      </div>
    </div>

    </main>
    <!-- Firebase 초기화 스크립트 --> 
  <script>
  //   function iframeTest(){
  //   var message = 'Hello from parent window!';
  //     window.parent.postMessage(message, '*');


  //   // 부모 페이지로 메시지를 보낸 후 응답 처리

  //     if (event.origin !== window.location.origin) return; // 보안을 위한 검사
  //     console.log('Received message from parent:', event.data);

  //     // 부모 페이지에 응답 보내기
  //     event.source.postMessage('Response from child', event.origin);
  //     console.log(message.data)
  // }
        let count = 0;
        let count2 = 0;
        let map;
        let markers = [];
        window.onload = function() {
            // 업로드된 폴더 목록 가져오기
            // 맵 초기화
            initMap();

          folderList()
          // iframeTest()
          profileLoad()
          printMessage()
        };  


function printMessage(){
  window.addEventListener("message", function(message){
    console.log(message.data);
})}
document.addEventListener('DOMContentLoaded', () => {
      const submitBtn = document.getElementById('submit-btn');

      submitBtn.addEventListener('click', () => {
          // Get values from the input fields
          const logo = document.getElementById('logo').value;
          const address = document.getElementById('address').value;
          const label = document.getElementById('label').value;

          // Store values in variables
          var geocoder = new google.maps.Geocoder();
        
          geocodeAddress(geocoder, address,label);
          
          
});});

async function uploadfile(file){
  const response = await fetch("https://gongdo.kr/api/datapi/place/record/add",{
            method:"POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                datapiId: "eNRiOKLhAvdRTUjocI2J",
                groupId:"default",
                form:{
                  label:"공도",
                  dataPack:file
                }
            })
            
          })
  const result= await response.json()

  console.log(result.resultData)
}
async function profileLoad(){
  const profilePhoto = document.getElementById("profilePhoto");
  const response = await fetch("https://gongdo.kr/api/datapi/place/list", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        datapiId: "eNRiOKLhAvdRTUjocI2J",
        groupId: 'default'
    })        
  });
  
  const result = await response.json();

  profilePhoto.innerHTML = ""; // 기존 내용 초기화

  // 이미지 주소
  const imageUrl = "https://firebasestorage.googleapis.com/v0/b/microschool-gongdo.appspot.com/o/prod%2Fres%2FPorsche%20web%2Ftest%2Fbee.png?alt=media&token=1ec62c16-c7b7-45e2-a9e5-0f5b0e286dbe";

  // 이미지 요소 생성
  const img = document.createElement("img");
  img.src = imageUrl; // 이미지 URL 설정
  img.alt = "Profile Photo"; // 대체 텍스트 설정 (옵션)
  img.width = 100; // 이미지 너비 설정 (옵션)
  img.style.borderRadius = "50%"; // 동그랗게 설정
  img.style.border="2px rgb(37,86,246) solid"
  img.style.padding="10px"
  img.style.backgroundColor="white"

  // 프로필 사진 요소에 이미지 추가
  profilePhoto.appendChild(img);
}
  
async function folderList(){
  const folderList = document.getElementById("folderZip");
  const response = await fetch("https://gongdo.kr/api/datapi/place/list",{
    method:"POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        datapiId: "eNRiOKLhAvdRTUjocI2J",
        groupId: ''
    })        
  });
  var i;

  const result = await response.json();
  const total = result.resultData.total
  for(i = 0; i < total; i++){
    let resultAddress = result.resultData.items[i].address
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': resultAddress }, function(results, status) {

        if (status === 'OK') {
            const location = results[0].geometry.location;
            addMarker(location, address);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
  }
  console.log(result.resultData.items[0].address);

  folderList.innerHTML = ""; // 기존 내용 초기화

  result.resultData.items.forEach(item => {
    const listItem = document.createElement("li"); // 새로운 li 요소 생성
    const nameItem = document.getElementById("nameItem");
    
    // 이미지 요소 생성 및 설정
    const img = document.createElement("img");
    img.src = "https://firebasestorage.googleapis.com/v0/b/microschool-gongdo.appspot.com/o/prod%2Fres%2FPorsche%20web%2Ftest%2Fbee.png?alt=media&token=1ec62c16-c7b7-45e2-a9e5-0f5b0e286dbe"; // 이미지 URL 설정
    img.alt = item.label; // 대체 텍스트 설정 (옵션)
    img.width = 50; // 이미지 너비 설정 (옵션)
    img.style.borderRadius = "50%"; // 동그랗게 설정
    listItem.appendChild(img); // 이미지를 li 요소에 추가

    // 텍스트 요소 생성 및 설정
    const textNode = document.createTextNode(item.label); // label 값을 텍스트 노드로 설정
    listItem.appendChild(textNode); // 텍스트 노드를 li 요소에 추가

    folderList.appendChild(listItem); // 생성한 li 요소를 folderList에 추가

    // 클릭 이벤트 추가
    listItem.addEventListener('click', () => {
      document.getElementById('secondwindow').style.display = 'block';
      // 또는 다른 동작을 수행할 수 있습니다.
      const resultLabel = item.label
      const resultAddress = item.address 
      const resultLogo = item.logo
      opensecondwindow(resultLabel, resultAddress , resultLogo)
    });
  });
}


function receiveMessage(event) {
  event.source.postMessage(
    "hi there yourself!  the secret response " + "is: rheeeeet!",
    event.origin,
  );
}
window.addEventListener("message", receiveMessage, false);

function geocodeAddress(geocoder, address,label) {
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();
                    fetch("https://gongdo.kr/api/datapi/place/add",{
            method:"POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                datapiId: "eNRiOKLhAvdRTUjocI2J",
                groupId: 'default',
                form: {
                  label,
                  address,
                  geolocation: {
                    lat,
                    lng
                  }
                }
            })
            
          }).then((res)=> {
            console.log(res);
            })
          // .then((result) => console.log("결과: ", result));
          // Output the formData to the console (or handle as needed)
        } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
          }
            )
            }


function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview').src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  } else {
    document.getElementById('preview').src = "";
  }
}


function initAutocomplete() {
    // Create the autocomplete object, restricting the search predictions to geographical location types.
    const autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('address'),
        { types: ['geocode'] }
    );

    // When the user selects an address from the dropdown, populate the address fields in the form.
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        const otherElement = document.getElementById('other-element'); // 다른 요소의 ID를 가져옵니다.

        // Clear previous contents
        otherElement.innerHTML = "";

        // Get the address components and display them.
        place.address_components.forEach(component => {
            const componentSpan = document.createElement('span');
            componentSpan.textContent = component.long_name;
            otherElement.appendChild(componentSpan);
        });
    });
}


function addschool(){
  initAutocomplete()
  secondwindow.classList.toggle('secondwindow-click',false)
  let addFolderDisplay = document.getElementById('addFolderDisplay');
  addFolderDisplay.style.display="block"

}
function closedWindow(){
  addFolderDisplay.style.display="none"
}
function searchAddress(){
  const searchInput = document.getElementById("search");
    const searchValue = searchInput.value.trim(); // 공백 제거
    
    // 검색어로 폴더 리스트 정렬
    sortFolderList(searchValue);
    let searchAddressValue = document.getElementById("search").value;
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': searchAddressValue }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}
function fixBtn(){
  
  const fixaddress = document.getElementById('address').value;
  const infoHidden = document.getElementById('info-form-hidden');
  if(fixaddress){
    addFolderDisplay.classList.toggle('addFolderDisplay-click',true)
    infoHidden.classList.toggle('info-form-block',true)
    
  }
  

}
function sortFolderList(searchValue) {
    const folderList = document.getElementById('folder-list');
    const folders = folderList.getElementsByTagName('li');

    for (let i = 0; i < folders.length; i++) {
        const folder = folders[i];
        const folderName = folder.textContent || folder.innerText;
        
        // 검색어가 폴더 이름에 포함되어 있는지 확인
        if (folderName.includes(searchValue)) {
            // 매칭되는 폴더를 맨 위로 이동
            folderList.insertBefore(folder, folderList.firstChild);
        }
    }
}
function searchAddressfromFolder(folderRef){
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': folderRef.name }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}

function leftThing(){
    const secondwindow = document.getElementById("secondwindow")
    const arrow = document.getElementById("arrow")
    
    const leftThing = document.getElementById("leftThing")
    leftThing.classList.add('leftThing-click' , true)


    if(count%2==0){
        leftThing.classList.toggle('leftThing-click',true);
        count = count+1;
    }
    else if(count%2==1){
        leftThing.classList.toggle('leftThing-click',false);

        count = count+1;
        secondwindow.classList.toggle('secondwindow-click' , false)
        count2=0;
    }
}
function opensecondwindow(resultLabel,resultAddress,resultLogo){
    secondwindow.classList.toggle('secondwindow-click')
    secondwindow.innerHTML='<h1>'+resultLabel+'</h1>'

    closedWindow()
}

function displaynone(){
    document.getElementById('left').style.display = 'none';
    sel.innerHTML='<span id="addressbar" onclick=displaynone()>학교목록 >';
}
        
function addbtn(){
  document.getElementById('addwindow').style.display = 'block';
}
        
        // 파일 처리하기
function sleep(ms) {
    const wakeUpTime = Date.now() + ms;
    while (Date.now() < wakeUpTime) {}
}

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5642135, lng: 127.0016985 },
        zoom: 8,
        disableDefaultUI: true,
        styles:[
  {
    "elementType": "geometry",
    "stylers": [
  {
    "featureType": "road",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  }
]
  }
]})


// 마커 클러스터러 생성
    markerCluster = new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
    });
   
    }
      function geocodeAndMark(address , folderRef) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    const marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: address
                    });
                    
                    // 클릭 이벤트 리스너 추가
                    marker.addListener('click', function() {
                        const infowindow = new google.maps.InfoWindow({
                            content: address
                        });
                        infowindow.open(map, marker);
                        opensecondwindow(folderRef)

                        // 원하는 동작 추가
                        // 예: 특정 정보를 오른쪽 정보 창에 표시
                        
                    });

                } else {
                    console.error('Geocode was not successful for the following reason:', status);
                }
            });
        }

        // 맵에 마커 추가
function addMarker(location, address) {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: address,
        icon: {
        url: 'https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fbee.png?alt=media&token=4707b1b3-67fc-4d7c-a57a-53d5ef4265a4', // 변경할 마커 이미지의 URL
        scaledSize: new google.maps.Size(50, 50), // 이미지 크기 조절
        origin: new google.maps.Point(0, 0), // 이미지의 원점 설정
        anchor: new google.maps.Point(25, 25) // 이미지의 중심점 설정
    }


    });
    marker.addListener('click', function() {
        const right_info = document.getElementById("right_info");
        right_info.classList.add('right_info_moved');
        right_info.classList.toggle('right_info_moved');
        // 마커의 주소 가져오기
        const markerAddress = marker.getTitle();

        // 인포윈도우 생성
        const infowindow = new google.maps.InfoWindow({
            content: markerAddress
        });

// 클릭한 마커 위에 인포윈도우 표시
infowindow.open(map, marker);
});
// 마커 위치로부터 주소를 지오코딩하는 함수




markers.push(marker); // 마커를 배열에 추가

// 클러스터러에 마커 추가
markerCluster.addMarker(marker);


// 폴더 경로에서 주소를 가져와 맵에 마커 표시
function addAddressMarker(resultAddress) {
  alert("hi")
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': address }, function(results, status) {

        if (status === 'OK') {
            const location = results[0].geometry.location;
            addMarker(location, address);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}}

    </script>
</body>
</html>