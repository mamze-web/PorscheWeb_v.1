<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Storage 파일 업로드 및 그래프</title>
    <!-- Chart.js 및 JSZip 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Google Maps API 및 MarkerClusterer 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDz2CZvDe4dViR8sxKPoTG-mNOUu6-AMeY&libraries=places"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>
    <main>
      
      
    
      <div id="file-list"></div>

        <div id="leftThing" > 
          <br>
          <div class="flex2">
          <div id="profileName"></div>
        </div>
        <div class="flex2">
        <div id="profileWarning"></div>
      </div>
            <div class="flex2">
              <button id="addschool" onclick="addschool()">주소 찾기</button>
            </div>
            <div class="flex2">
            <div id="line"></div>
          </div>
            <div class="flex2">
              <h1 id="otherDatapi">다른 데이터파이 둘러보기</h1>
            </div>
            <div id="folder">
              <div class="flex2">
            <div id="folderZip">
            </div>
            </div>
            <div id="addFolderDisplay">

              <div class="flex">
                <div id="add">
              <h1>주소 추가하기</h1>
              <div id="x" onclick="closedWindow()"><h1>x</h1></div>
              </div>
            </div>
              <form id="info-form">
    
              
                <div class="flex">

                      <input id="address" type="text" placeholder="주소를 입력해주세요!" />
    
                      <button type="button" id="fixbutton" onclick="fixBtn()">검색</button>
                      
                  
                  </div>
                  <div id="addressDisplay"></div>
                  <div id="info-form-zip">
                  <div id="info-form-hidden">
                <!-- <div id="info-form-flex"> -->
                  
                
              <div class="flex3">
                <div id="suggestions" class="suggestions"></div>
              </div>
              <div class="flex">
                <div id="logoZip">
                 
                  <br>
                  <label id="logolabel" for="logo">
                    <img id="preview" />
                  </label>
                  <input type="file" id="logo" name="logo"onchange="readURL(this);" ><br><br>
              </div>
                <div class="flex">
                  <div id="display-block">
                  <label for="label" id="displayName"><h4>정보 등록하기</h4></label>
                  <input type="text" id="label" name="label">
                  </div>
                </div>
              </div>
                <!-- </div> -->
                <div class="flex">
                  <button type="button" id="submit-btn" onclick="closedWindow()">주소 찾기</button>
                </div>
              </div>
              </div>
                </form>
    
          
        </div>
          </div>

           
          <div id="ifinfomation">
            
          </div>
          
            <div id="secondwindow">
              <div class="flex">
              <div class="flex4">
              <div id="headText">데이터 파이 조회</div>
              <div id="x" onclick="closedLeftArrow()">x</div>
              </div>
            </div>
              <div class="flex">
              <div id="headList">
              <div id="secondwindowLogo"></div>
              <div id="headText">
                <div id="secondwindowHead"></div>
                <div id="secondwindowAddress"></div>
                <div id="secondwindowTotal"></div>
              </div>
            </div>
            </div>
            <hr>
            <br>
            <div class="flex">
              <div id="textBetween">
            <h1 id="headText2">등록한 데이터</h1>
            <div id="recordUploadsZip">
              <input id="recordUploads" type="file">
              <label id="recordLabel" for="recordUploads">등록 +</label>
            </div>
          </div>
            </div>
            <div class="flexRecord">
            <div id="secondwindowRecord"></div>
            </div>
            </div>
            

            
            <div id="clickarrow"onclick="leftThing()">
                <span id="arrow">✔️ 나의 주소 추가하기</span>
            </div>
            
               

            </div>
            
               
           
       
   
        <div id="addwindow">
        </div>
            </div>
            <div class="blur">
                <div id="map"></div>     
            </div>

            <div id="right_info">
                
            </div>         
            </div>    
        </div>
      </div>
    </div>
    
    </main>
    <button id="authButton" onclick="printMessage()">Auth!</button>
    <!-- Firebase 초기화 스크립트 --> 
  <script>
    let globalResultAuthData; // 전역 변수 선언

    function AuthEvent(event) {
      console.log(event.data);
      console.log("this is Test")
      // event.source.postMessage(
      //   "hi there yourself!  the secret response " + "is: rheeeeet!",
      //   event.origin,
      // );
      
      globalResultAuthData = JSON.parse(event.data); // 전역 변수에 값 할당
      isAuth = globalResultAuthData.body.isAuth
      console.log(isAuth)
    }

    window.addEventListener("message", AuthEvent, false);


  //   function iframeTest(){
  //   var message = 'Hello from parent window!';
  //     window.parent.postMessage(message, '*');


  //   // 부모 페이지로 메시지를 보낸 후 응답 처리

  //     if (event.origin !== window.location.origin) return; // 보안을 위한 검사
  //     console.log('Received message from parent:', event.data);

  //     // 부모 페이지에 응답 보내기
  //     event.source.postMessage('Response from child', event.origin);
  //     console.log(message.data)
  // }
        let count = 0;
        let count2 = 0;
        let map;
        let markers = [];
        window.onload = function() {
            // 업로드된 폴더 목록 가져오기
            // 맵 초기화
            initMap();

          folderList()
          // iframeTest()
          profileLoadAuth()
        };  
function printMessage(){
  console.log(globalResultAuthData)
        }
// function absoluteAuth(){
//     const value = window.localStorage.getItem("init-state");
//     const jsonValue = JSON.parse(value);
//     console.log(jsonValue)
//     console.log(value)

//     const parentValue = window.parent.localStorage.getItem("init-state")
//     const jsonParentValue = JSON.parse(parentValue);
//     console.log(jsonParentValue)
//     console.log(parentValue)
    
//     return jsonValue;
// }

// async function absoluteAuthHardCoding(){
//   const groupId = [
//     'default',
//     'true',
//     'false'
//   ]
//   return groupId
// }
function getCurrentDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // getMonth()는 0부터 11까지 반환하므로 +1이 필요합니다.
    const day = String(today.getDate()).padStart(2, '0');

    return `${year}년${month}월${day}일`;
}

let zipFile;  // ZIP 파일을 저장할 변수
let recordZip;
let myLabel;
let myPlace;
let base64File
let pngBase64String
let isAuth
document.getElementById('recordUploads').addEventListener('change', function(event) {
    const file = event.target.files[0];

    
    if (file && file.name.endsWith('.zip')) {
        zipFile = file;  
        console.log('ZIP file selected:', zipFile);

    
        encodeZIPToBase64(zipFile);
    } else {
        console.error('Please provide a ZIP file.');
    }
});

function encodeZIPToBase64(file) {
    const reader = new FileReader();

    reader.onload = function(e) {
        const base64String = e.target.result.split(',')[1];
        recordUploads(base64String)
    };

    // reader.readAsDataURL(file); 
}

async function recordUploads(base64String){
  const recordFile = base64String
  const today = getCurrentDate();
  const groupIdAuth = globalResultAuthData.body.groupId
  console.log(recordFile)
  console.log(myLabel)
  console.log(myPlace)
  const response = await fetch("https://gongdo.kr/api/datapi/place/record/add",{
            method:"POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                datapiId: "eNRiOKLhAvdRTUjocI2J",
                placeId:myPlace,
                form:{
                  label:today,
                  dataPack:recordFile
                }
            })
            
          })
  const result= await response.json()

  console.log(result.resultData)
}
document.getElementById('logo').addEventListener('change', function(event){
  const file = event.target.files[0];
  if (!file) {
    base64Output.value = 'No file selected.';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(event) {
    pngBase64String = event.target.result.split(',')[1];
  };

  reader.readAsDataURL(file);
});
function encodeZIPToBase64(file) {
  if (file && file.name.endsWith('.zip')) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const base64String = e.target.result.split(',')[1];  // Get the base64 string without the data URI prefix
            recordUploads(base64String);
        };

        reader.readAsDataURL(file);
        
    } else {
        console.error('Please provide a ZIP file.');
    }
}
document.addEventListener('DOMContentLoaded', () => {
      const submitBtn = document.getElementById('submit-btn');

      submitBtn.addEventListener('click', () => {
          // Get values from the input fields
          const fileImg = document.getElementById('logo').value;
                if (fileImg && fileImg.type === 'image/png') {
              const reader = new FileReader();
              
              reader.onload = function(e) {
                  const base64String = e.target.result.split(',')[1];  // Get the base64 string without the data URI prefix
                  console.log(base64String);
              };
              
              reader.readAsDataURL(fileImg);
          } else {
              console.error('Please provide a PNG image.');
          }
          const address = document.getElementById('address').value;
          const label = document.getElementById('label').value;

          // Store values in variables
          var geocoder = new google.maps.Geocoder();
        
          geocodeAddress(geocoder, address,label,logo);
          
          
});})


async function profileLoad(groupIdAuth){
   
  const response = await fetch("https://gongdo.kr/api/datapi/place/list", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        datapiId: "eNRiOKLhAvdRTUjocI2J",
        groupId: groupIdAuth
    })        
  });
  const result = await response.json();
  return result;
}
async function profileLoadAuth() {
  try {
    const AuthData = globalResultAuthData
    // const groupIdAuth = AuthData.body.groupId
    // const isClassMember = AuthData.body.isClassMember
    // console.log(groupIdAuth , isClassMember)
  } catch (error) {
    console.error(error);
  }
}
  
async function folderList() {
  const folderList = document.getElementById("folderZip");
  const response = await fetch("https://gongdo.kr/api/datapi/place/list", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      datapiId: "eNRiOKLhAvdRTUjocI2J",
      groupId: ''
    })
  });
  const result = await response.json();
  console.log(result);
  const sortedItems = result.resultData.items.sort((a, b) => {
    const labelA = a.label.toUpperCase(); // 대소문자 구분 없이 비교하기 위해 대문자로 변환
    const labelB = b.label.toUpperCase(); // 대소문자 구분 없이 비교하기 위해 대문자로 변환
    if (labelA < labelB) return -1;
    if (labelA > labelB) return 1;
    return 0;
  });

  folderList.innerHTML = ""; // 기존 내용 초기화

  sortedItems.forEach(item => {
    const listItem = document.createElement("li"); // 새로운 li 요소 생성

    // 이미지 요소 생성 및 설정
    const resultLogo = item.logo;
    const img = document.createElement("img");
    img.border='1px'
    if (resultLogo) {
      img.src = 'data:image/png;base64,' + resultLogo;
    } else {
      // 결과로 받은 로고가 없는 경우 기본 이미지를 사용합니다.
      img.src = 'https://firebasestorage.googleapis.com/v0/b/microschool-gongdo.appspot.com/o/prod%2Fres%2FPorsche%20web%2Fimg%2Fuser.png?alt=media&token=2a50dc30-9c41-46f3-8ea1-77ee170fc29b';
    }
    img.alt = item.label; // 대체 텍스트 설정
    img.style.borderRadius = "50%"; // 동그랗게 설정
    listItem.appendChild(img); // 이미지를 li 요소에 추가

    // 텍스트 요소 생성 및 설정
    const textNode = document.createTextNode(item.label); // label 값을 텍스트 노드로 설정
    listItem.appendChild(textNode); // 텍스트 노드를 li 요소에 추가

    folderList.appendChild(listItem); // 생성한 li 요소를 folderList에 추가

    // 클릭 이벤트 추가
    listItem.addEventListener('click', () => {
      opensecondwindow(item.label, item.address, item.id, resultLogo);
      document.getElementById('secondwindow').style.display = 'block';
      myLabel = item.label;
      myPlace = item.id;
      opensecondwindow(item.label, item.address, item.id, resultLogo);
    });
  });
}



function geocodeAddress(geocoder, address,label,logo) {
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();
                    fetch("https://gongdo.kr/api/datapi/place/add",{
            method:"POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                datapiId: "eNRiOKLhAvdRTUjocI2J",
                groupId: 'default',
                form: {
                  label,
                  logo:pngBase64String,
                  address,
                  geolocation: {
                    lat,
                    lng
                  
                }
            }})
            
          }).then((res)=> {
            console.log(res);
            })
          // .then((result) => console.log("결과: ", result));
          // Output the formData to the console (or handle as needed)
        } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
          }
            )
            folderList()
            }


function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    
    reader.onload = function(e) {
      document.getElementById('preview').src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  } else {
    document.getElementById('preview').src = "";
  }

}

function initAutocomplete() {
      var input = document.getElementById('address');
      var fixBtn = document.getElementById('fixbutton');
      var suggestionsContainer = document.getElementById('suggestions');
      var autocompleteService = new google.maps.places.AutocompleteService();
      var selectedItem = null;

      fixbutton.addEventListener('click', function() {
        var value = input.value;
        if (value) {
          autocompleteService.getPlacePredictions({ input: value }, function(predictions, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              suggestionsContainer.innerHTML = '';
              predictions.slice(0, 2).forEach(function(prediction) {
                var suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionsContainer.appendChild(suggestionItem);

                // 클릭 시 선택한 주소로 input 값 설정 및 스타일 변경
                suggestionItem.addEventListener('click', function() {
                  input.value = prediction.description;

                  // 이전 선택 항목 스타일 초기화
                  if (selectedItem) {
                    selectedItem.classList.remove('suggestion-item-click');
                  }

                  // 현재 선택 항목 스타일 설정
                  suggestionItem.classList.add('suggestion-item-click');
                  selectedItem = suggestionItem;
                });
              });
            }
          });
        } else {
          suggestionsContainer.innerHTML = '';
        }
      });
    }

    google.maps.event.addDomListener(window, 'load', initAutocomplete);
  

function addschool(){
  secondwindow.classList.toggle('secondwindow-click',false)
  let addFolderDisplay = document.getElementById('addFolderDisplay');
  addFolderDisplay.style.display="block"
  
  document.getElementById('secondwindow').style.display = 'none';
}
function closedWindow(){
  addFolderDisplay.style.display="none"
}

function fixBtn(){
  initAutocomplete();
  const fixaddress = document.getElementById('address').value;
  const infoHidden = document.getElementById('info-form-hidden');
  if(fixaddress){
    addFolderDisplay.classList.toggle('addFolderDisplay-click',true)
    infoHidden.classList.toggle('info-form-block',true)
    
  }
  

}



function leftThing(){
    const secondwindow = document.getElementById("secondwindow")
    const arrow = document.getElementById("arrow")
    
    const leftThing = document.getElementById("leftThing")
    leftThing.classList.add('leftThing-click' , true)


    if(count%2==0){
        leftThing.classList.toggle('leftThing-click',true);
        count = count+1;
    }
    else if(count%2==1){
        leftThing.classList.toggle('leftThing-click',false);

        count = count+1;
        secondwindow.classList.toggle('secondwindow-click' , false)
        count2=0;
    }
}
function closedLeftArrow(){
  secondwindow.style.display = "none";
}
async function opensecondwindow(resultLabel, resultAddress, resultId, resultLogo, isAuth) {
  const secondwindowhead = document.getElementById('secondwindowHead');
  const secondImg = document.getElementById('secondwindowLogo');
  const secondAddress = document.getElementById('secondwindowAddress');
  const secondTotal = document.getElementById('secondwindowTotal');
  const secondRecord = document.getElementById('secondwindowRecord');
  const secondwindow = document.getElementById('secondwindow'); // secondwindow 요소를 참조

  closedWindow();
  secondwindow.style.display = "block";
  secondwindowhead.innerHTML = '<h1>' + resultLabel + '</h1>';
  secondRecord.innerHTML = ""; // 여기에서 한 번 초기화합니다.

  // 기본 프로필 이미지 URL
  const defaultImgUrl = 'https://firebasestorage.googleapis.com/v0/b/microschool-gongdo.appspot.com/o/prod%2Fres%2FPorsche%20web%2Fimg%2Fuser.png?alt=media&token=2a50dc30-9c41-46f3-8ea1-77ee170fc29b';

  // 기존에 있는 이미지를 모두 제거합니다.
  while (secondImg.firstChild) {
    secondImg.removeChild(secondImg.firstChild);
  }

  // 결과로 받은 로고가 있는 경우 이미지를 표시하고, 없는 경우 기본 이미지를 표시합니다.
  if (resultLogo) {
    const img = document.createElement("img");
    img.src = 'data:image/png;base64,' + resultLogo;
    img.alt = resultLabel; // 대체 텍스트 설정
    img.style.borderRadius = "50%"; // 동그랗게 설정
    secondImg.appendChild(img); // 이미지를 secondImg 요소에 추가
  } else {
    // 결과로 받은 로고가 없는 경우 기본 이미지를 표시합니다.
    const defaultImg = document.createElement("img");
    defaultImg.src = defaultImgUrl;
    defaultImg.alt = "기본 프로필 사진";
    defaultImg.style.borderRadius = "50%";
    secondImg.appendChild(defaultImg);
  }

  const response = await fetch("https://gongdo.kr/api/datapi/place/record/list", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      datapiId: "eNRiOKLhAvdRTUjocI2J",
      placeId: resultId
    })
  });

  const result = await response.json();
  console.log(result);

  secondTotal.innerHTML = "등록된 데이터: " + result.resultData.total + "개";

  const total = result.resultData.total;

  // items가 배열인지 확인하고 처리합니다.
  if (Array.isArray(result.resultData.items)) {
    for (let i = 0; i < total; i++) {
      // li 요소 새로 생성
      const listItem = document.createElement("li");

      // 텍스트 요소 생성 및 설정
      const textNode = document.createTextNode(result.resultData.items[i].label); // label 값을 텍스트 노드로 설정

      // 버튼 요소 생성 및 설정
      const button = document.createElement("button");
      button.textContent = "그래프 보기"; // 버튼에 텍스트 설정

      // 버튼 클릭 시 그래프 표시/숨김 토글
      button.onclick = function() {
        const graphDiv = listItem.nextElementSibling;
        if (graphDiv && graphDiv.classList.contains('graph-div')) {
          // 그래프가 이미 표시되어 있으면 삭제
          graphDiv.remove();
        } else {
          // 그래프가 표시되어 있지 않으면 새로운 div 요소 생성하여 추가
          const newGraphDiv = document.createElement("div");
          newGraphDiv.classList.add('graph-div'); // 클래스 추가
          const resultPreview = result.resultData.items[i].dataPackage.preview;
          const resultZip = result.resultData.items[i].dataPackage.zip;
          console.log(resultZip)
          console.log(resultPreview);
          
          newGraphDiv.innerHTML = "<div class'flex'><img id='previewGraph' src=" + resultPreview + " /><br><a href=" + resultZip + " download='file.zip' id='dnBtn'>다운로드</a> "; // 예시 텍스트 설정
          newGraphDiv.style.padding = "10px"; // 스타일 설정
          newGraphDiv.style.marginTop = "10px"; // 스타일 설정
          listItem.insertAdjacentElement('afterend', newGraphDiv); // 형제 요소로 추가
        }
      };

      // 텍스트 노드와 버튼을 li 요소에 추가
      listItem.appendChild(textNode);
      listItem.appendChild(button);

      // li 요소를 secondRecord에 추가
      secondRecord.appendChild(listItem);
    }
  } else {
    console.warn('resultData.items is not an array:', result.resultData.items);
  }
}



function displaynone(){
    document.getElementById('left').style.display = 'none';
    sel.innerHTML='<span id="addressbar" onclick=displaynone()>학교목록 >';
}
        
function addbtn(){
  document.getElementById('addwindow').style.display = 'block';
}
        
        // 파일 처리하기
function sleep(ms) {
    const wakeUpTime = Date.now() + ms;
    while (Date.now() < wakeUpTime) {}
}
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 37.5642135, lng: 127.0016985 },
    zoom: 8,
    disableDefaultUI: true,
    styles:[
      {
        "featureType": "road",
        "elementType": "geometry",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      }
    ]
  });

  // 마커 클러스터러 생성
  markerCluster = new MarkerClusterer(map, [], {
    imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
  });
}

// addMarker 함수 수정하여 마커 클릭 시 인포윈도우 표시
function addMarker(location, address, resultLogo) {
  const marker = new google.maps.Marker({
    position: location,
    map: map,
    icon: {
      url: 'data:image/png;base64,' + resultLogo,
      scaledSize: new google.maps.Size(50, 50), // 이미지 크기 조절
      origin: new google.maps.Point(0, 0), // 이미지의 원점 설정
      anchor: new google.maps.Point(25, 25) // 이미지의 중심점 설정
    }
  });

  // 클릭 이벤트 리스너 추가
  marker.addListener('click', function() {
    const infowindow = new google.maps.InfoWindow({
      content: address
    });
    infowindow.open(map, marker);
  });

  // 마커를 배열에 추가
  markers.push(marker);

  // 클러스터러에 마커 추가
  markerCluster.addMarker(marker);
}

    </script>
</body>
</html>