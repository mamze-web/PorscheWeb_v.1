<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Storage 파일 업로드 및 그래프</title>
    <!-- Chart.js 및 JSZip 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- Google Maps API 및 MarkerClusterer 추가 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDz2CZvDe4dViR8sxKPoTG-mNOUu6-AMeY&libraries=places"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
</head>
<body>
    <main>
      <div id="addFolderDisplay">
        <input type="text" id="folderNameInput" placeholder="Enter folder name">
        <button onclick="uploadFile()">Upload</button>
        <span id="closedWindow" onclick="closedWindow()">X</span>
      </div>
      <div id="file-list"></div>
        <div id="leftThing" > 
            <div id="secondwindow">
              
            </div>
            <div id="clickarrow"onclick="leftThing()">
                <span id="arrow">></span>
            </div>
            <div id="openwindow" >
                <div>
                <div id="searchzip">
                <img id="searchimg" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fsearch-interface-symbol.png?alt=media&token=a2fe1515-97b0-414f-9900-26280b475c19">
                <input id="search" type="text"  placeholder="주소를 검색하세요." onchange="searchAddress()">
                <div id="line"></div>
                </div>
                <hr>
                <div id="folder">
                <div class="folderZip">
                <ul id="folder-list"></ul>
                </div>
                <button id="addschool" onclick="addschool()">학교추가</button>
                </div>
                </div>
                <div id="honeycombtext">
                <img class="honeycomb" src="https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fhoneycomb.png?alt=media&token=09a7fc9b-6f08-42f3-b123-c0e2a6bc66d4">
                <span>공학도서관 X Porsche</span>
                </div>
              </div>
            </div>
            
               
           
        </div>
     
   
        <div id="addwindow">
        </div>
            </div>
            <div class="blur">
                <div id="map"></div>     
            </div>

            <div id="right_info">
                
            </div>         
            </div>    
        </div>
    </main>
    <!-- Firebase 초기화 스크립트 -->
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
    <script>
        let count = 0;
        let count2 = 0;
        let map;
        let markers = [];
        window.onload = function() {
            // 업로드된 폴더 목록 가져오기
            // 맵 초기화
            iframeload();
            initMap();
            listFolders();

        };  
        const firebaseConfig = {
            apiKey: "AIzaSyAz3IZwipq6OS8f9ucO9j1ZKxyo-u78NIw",
  authDomain: "macband-cf215.firebaseapp.com",
  databaseURL: "https://macband-cf215-default-rtdb.firebaseio.com",
  projectId: "macband-cf215",
  storageBucket: "macband-cf215.appspot.com",
  messagingSenderId: "586331708886",
  appId: "1:586331708886:web:8a4416d2e48e9565c65877"
        };

        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const listFolders = async () => {
            const storageRef = storage.ref().child('uploads');
            const folderList = document.getElementById('folder-list');

            try {
                const res = await storageRef.listAll();
                folderList.innerHTML = '';
                res.prefixes.forEach((folderRef) => {
                    const li = document.createElement('li');
                    li.textContent = folderRef.name;
                    li.onclick = () => {
                        opensecondwindow(folderRef)
                        listFiles(folderRef);
                        searchAddressfromFolder(folderRef)
                    }
                    folderList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing folders:', error);
            }
            const handleFolderClick = (folderRef) => {
            alert(`You clicked on folder: ${folderRef}`);
            // 여기에 원하는 기능을 추가하십시오.
        };}
        async function uploadFile() {
          
      const folderName = document.getElementById('folderNameInput').value;
      if (!folderName) {
        alert('Please enter a folder name.');
        return;
      }

      const fileName = 'sample.txt';
      const fileContent = 'This is a sample file content.';

      // Create a Blob from the file content
      const blob = new Blob([fileContent], { type: 'text/plain' });

      // Create a reference to the file in the specified folder
      const storageRef = storage.ref().child(`uploads/${folderName}/${fileName}`);

      // Upload the file
      try {
        await storageRef.put(blob);
        addFolderDisplay.classList.toggle('addFolderDisplay-click')
        console.log('File uploaded successfully.');
        // Refresh the folder list after upload
        listFolders();
      } catch (error) {
        console.error('Upload failed:', error);
      }
    }
    listFolders();

function iframeload(){
  window.addEventListener("message", function(message){
    alert(message.data);
    window.parent.postMessage(text);
  })
  
}

function addschool(){
  let addFolderDisplay = document.getElementById('addFolderDisplay');
  addFolderDisplay.classList.toggle('addFolderDisplay-click')
}
function closedWindow(){
  addFolderDisplay.classList.toggle('addFolderDisplay-click')
}
function searchAddress(){
  const searchInput = document.getElementById("search");
    const searchValue = searchInput.value.trim(); // 공백 제거
    
    // 검색어로 폴더 리스트 정렬
    sortFolderList(searchValue);
    let searchAddressValue = document.getElementById("search").value;
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': searchAddressValue }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}
function sortFolderList(searchValue) {
    const folderList = document.getElementById('folder-list');
    const folders = folderList.getElementsByTagName('li');

    for (let i = 0; i < folders.length; i++) {
        const folder = folders[i];
        const folderName = folder.textContent || folder.innerText;
        
        // 검색어가 폴더 이름에 포함되어 있는지 확인
        if (folderName.includes(searchValue)) {
            // 매칭되는 폴더를 맨 위로 이동
            folderList.insertBefore(folder, folderList.firstChild);
        }
    }
}
function searchAddressfromFolder(folderRef){
    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': folderRef.name }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}

function leftThing(){
    const secondwindow = document.getElementById("secondwindow")
    const arrow = document.getElementById("arrow")
    
    const leftThing = document.getElementById("leftThing")
    leftThing.classList.add('leftThing-click' , true)


    if(count%2==0){
        leftThing.classList.toggle('leftThing-click',true);
        arrow.innerHTML='<'
        count = count+1;
    }
    else if(count%2==1){
        leftThing.classList.toggle('leftThing-click',false);
        arrow.innerHTML='>'
        count = count+1;
        secondwindow.classList.toggle('secondwindow-click' , false)
        count2=0;
    }
}
function opensecondwindow(folderRef){
    secondwindow.classList.toggle('secondwindow-click' , true )
    secondwindow.innerHTML='<h1>'+folderRef.name+'</h1>'
}

function displaynone(){
    document.getElementById('left').style.display = 'none';
    sel.innerHTML='<span id="addressbar" onclick=displaynone()>학교목록 >';
}
        
function addbtn(){
  document.getElementById('addwindow').style.display = 'block';
}
        
        // 파일 처리하기
function sleep(ms) {
    const wakeUpTime = Date.now() + ms;
    while (Date.now() < wakeUpTime) {}
}

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5642135, lng: 127.0016985 },
        zoom: 8,
        disableDefaultUI: true,
        styles:[
  {
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#ebe3cd"
      }
    ]
  },
  {
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#523735"
      }
    ]
  },
  {
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#f5f1e6"
      }
    ]
  },
  {
    "featureType": "administrative",
    "elementType": "geometry.stroke",
    "stylers": [
      {
        "color": "#c9b2a6"
      }
    ]
  },
  {
    "featureType": "administrative.land_parcel",
    "elementType": "geometry.stroke",
    "stylers": [
      {
        "color": "#dcd2be"
      }
    ]
  },
  {
    "featureType": "administrative.land_parcel",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#ae9e90"
      }
    ]
  },
  {
    "featureType": "landscape.natural",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#dfd2ae"
      }
    ]
  },
  {
    "featureType": "poi",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#dfd2ae"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#93817c"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "geometry.fill",
    "stylers": [
      {
        "color": "#a5b076"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#447530"
      }
    ]
  },
  {
    "featureType": "road",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#f5f1e6"
      }
    ]
  },
  {
    "featureType": "road.arterial",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#fdfcf8"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#f8c967"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "elementType": "geometry.stroke",
    "stylers": [
      {
        "color": "#e9bc62"
      }
    ]
  },
  {
    "featureType": "road.highway.controlled_access",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#e98d58"
      }
    ]
  },
  {
    "featureType": "road.highway.controlled_access",
    "elementType": "geometry.stroke",
    "stylers": [
      {
        "color": "#db8555"
      }
    ]
  },
  {
    "featureType": "road.local",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#806b63"
      }
    ]
  },
  {
    "featureType": "transit.line",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#dfd2ae"
      }
    ]
  },
  {
    "featureType": "transit.line",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#8f7d77"
      }
    ]
  },
  {
    "featureType": "transit.line",
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#ebe3cd"
      }
    ]
  },
  {
    "featureType": "transit.station",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#dfd2ae"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "geometry.fill",
    "stylers": [
      {
        "color": "#b9d3c2"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#92998d"
      }
    ]
  }
]})
const storage = firebase.storage();
      const storageRef = storage.ref('uploads'); // uploads 폴더 경로

      storageRef.listAll().then(function(result) {
        result.prefixes.forEach(function(folderRef) {
          // 각 폴더의 이름 가져오기
          const folderName = folderRef.name;
          // 각 폴더의 위치를 지오코딩하여 마커로 표시
          geocodeAndMark(folderName ,folderRef);
        });

      }).catch(function(error) {
        // 에러 처리
        console.error("Error getting storage folder:", error);
      });
    
      storageRef.listAll().then(function(result) {
                result.prefixes.forEach(function(folderRef) {
                    const folderName = folderRef.name;
                    geocodeAndMark(folderName , folderRef);
                });
            }).catch(function(error) {
                console.error("Error getting storage folder:", error);
            });
            ;   ;

// 마커 클러스터러 생성
    markerCluster = new MarkerClusterer(map, markers, {
        imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
    });
   
    }
    
    function addNewFolder() {
      const storage = firebase.storage();
      const storageRef = storage.ref('uploads'); // uploads 폴더 경로

      // 새로운 폴더의 이름을 유니크하게 생성합니다.
      const newFolderName = "folder_" + Date.now();

      // 파이어베이스 Storage에 새로운 폴더 추가
      storageRef.child(newFolderName).putString('').then(function(snapshot) {
        console.log('새로운 폴더가 성공적으로 추가되었습니다.');
      }).catch(function(error) {
        console.error('새로운 폴더 추가 중 오류가 발생했습니다:', error);
      });
    }
    function geocodeAndMark(address , folderRef) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    const marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: address
                    });
                    
                    // 클릭 이벤트 리스너 추가
                    marker.addListener('click', function() {
                        const infowindow = new google.maps.InfoWindow({
                            content: address
                        });
                        infowindow.open(map, marker);
                        opensecondwindow(folderRef)

                        // 원하는 동작 추가
                        // 예: 특정 정보를 오른쪽 정보 창에 표시
                        
                    });

                } else {
                    console.error('Geocode was not successful for the following reason:', status);
                }
            });
        }

        // 맵에 마커 추가
function addMarker(location, address) {
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: address,
        icon: {
        url: 'https://firebasestorage.googleapis.com/v0/b/macband-cf215.appspot.com/o/Mac%20photo%2Fbee.png?alt=media&token=4707b1b3-67fc-4d7c-a57a-53d5ef4265a4', // 변경할 마커 이미지의 URL
        scaledSize: new google.maps.Size(50, 50), // 이미지 크기 조절
        origin: new google.maps.Point(0, 0), // 이미지의 원점 설정
        anchor: new google.maps.Point(25, 25) // 이미지의 중심점 설정
    }


    });
    marker.addListener('click', function() {
        const right_info = document.getElementById("right_info");
        right_info.classList.add('right_info_moved');
        right_info.classList.toggle('right_info_moved');
        // 마커의 주소 가져오기
        const markerAddress = marker.getTitle();

        // 인포윈도우 생성
        const infowindow = new google.maps.InfoWindow({
            content: markerAddress
        });

// 클릭한 마커 위에 인포윈도우 표시
infowindow.open(map, marker);
});
// 마커 위치로부터 주소를 지오코딩하는 함수




markers.push(marker); // 마커를 배열에 추가

// 클러스터러에 마커 추가
markerCluster.addMarker(marker);


// 폴더 경로에서 주소를 가져와 맵에 마커 표시
function addAddressMarker(folderPath, address) {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            addMarker(location, address);
        } else {
            console.error('지오코딩 에러:', status);
        }
    });
}}

    </script>
</body>
</html>